<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FORKLE</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&display=swap');

  :root {
    --amber: #ffaa33;
    --amber-dim: #8a5a1a;
    --amber-glow: #ffaa3340;
    --amber-bright: #ffcc66;
    --amber-faint: #ffaa3312;
    --bg: #000000;
    --bg-screen: #0a0800;
    --red: #ff4444;
    --red-dim: #882222;
    --border: #ffaa3320;
    --scanline-opacity: 0.04;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    height: 100%;
    background: var(--bg);
    overflow: hidden;
  }

  body {
    font-family: 'Berkeley Mono', 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
    color: var(--amber);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .frame {
    width: min(880px, 92vw);
    height: min(680px, 88vh);
    border: 1px solid var(--border);
    border-radius: 12px;
    position: relative;
    overflow: hidden;
    background: var(--bg);
  }

  .barrel-wrap {
    width: 100%;
    height: 100%;
    position: relative;
  }

  .barrel-shadow {
    position: absolute;
    inset: 0;
    z-index: 20;
    pointer-events: none;
    border-radius: 12px;
    background: radial-gradient(
      ellipse 78% 72% at 50% 50%,
      transparent 0%,
      transparent 55%,
      rgba(0, 0, 0, 0.18) 68%,
      rgba(0, 0, 0, 0.45) 80%,
      rgba(0, 0, 0, 0.75) 92%,
      rgba(0, 0, 0, 0.95) 100%
    );
  }

  .barrel-warp {
    position: absolute;
    inset: -2px;
    z-index: 21;
    pointer-events: none;
    border-radius: 14px;
    box-shadow:
      inset 0 6px 12px rgba(0,0,0,0.6),
      inset 0 -6px 12px rgba(0,0,0,0.6),
      inset 6px 0 12px rgba(0,0,0,0.5),
      inset -6px 0 12px rgba(0,0,0,0.5);
  }

  .scanlines {
    position: absolute;
    inset: 0;
    z-index: 15;
    pointer-events: none;
    background: repeating-linear-gradient(
      to bottom,
      transparent 0px,
      transparent 3px,
      rgba(0, 0, 0, var(--scanline-opacity)) 3px,
      rgba(0, 0, 0, var(--scanline-opacity)) 4px
    );
    border-radius: 12px;
  }

  .screen-inner {
    width: 100%;
    height: 100%;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 40px 52px;
    position: relative;
    z-index: 1;
    scrollbar-width: none;
  }
  .screen-inner::-webkit-scrollbar { display: none; }

  @keyframes flicker {
    0%, 100% { opacity: 1; }
    92% { opacity: 1; }
    93% { opacity: 0.94; }
    94% { opacity: 1; }
    97% { opacity: 0.97; }
    98% { opacity: 1; }
  }
  .screen-inner { animation: flicker 8s infinite; }

  .title-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    gap: 16px;
  }

  .title-logo {
    font-size: 120px;
    line-height: 1;
    margin-bottom: -4px;
    text-shadow: 0 0 30px var(--amber-glow);
  }

  .title-name {
    font-size: 36px;
    font-weight: 700;
    letter-spacing: 18px;
    text-indent: 18px;
    margin-bottom: 4px;
  }

  .title-story-name {
    font-size: 14px;
    font-weight: 400;
    color: var(--amber-dim);
    letter-spacing: 4px;
    text-transform: uppercase;
  }

  .title-objective {
    font-size: 13px;
    font-weight: 300;
    color: var(--amber-dim);
    max-width: 380px;
    line-height: 1.7;
    opacity: 0.6;
  }

  .title-prompt {
    font-size: 12px;
    color: var(--amber-dim);
    letter-spacing: 2px;
    margin-top: 28px;
    animation: blink 1.5s step-end infinite;
  }

  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  .game-container {
    display: none;
    flex-direction: column;
    min-height: 100%;
  }
  .game-container.active { display: flex; }
  .title-screen.hidden { display: none; }

  .hud {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 14px;
    margin-bottom: 24px;
    border-bottom: 1px solid rgba(255, 170, 51, 0.12);
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--amber-dim);
  }

  .hud-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .hud-logo {
    font-size: 20px;
    color: var(--amber);
    line-height: 1;
  }

  .hud-title { color: var(--amber-dim); }

  .hud-depth {
    color: var(--amber);
    font-weight: 500;
  }

  .scenario-text {
    font-size: 14.5px;
    line-height: 1.9;
    font-weight: 300;
    color: var(--amber);
    margin-bottom: 32px;
    min-height: 60px;
  }

  .scenario-text .cursor {
    display: inline-block;
    width: 8px;
    height: 16px;
    background: var(--amber);
    margin-left: 2px;
    vertical-align: text-bottom;
    animation: blink 0.8s step-end infinite;
  }

  .choices {
    display: flex;
    flex-direction: column;
    gap: 8px;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  .choices.visible { opacity: 1; }

  .choice-btn {
    background: transparent;
    border: 1px solid rgba(255, 170, 51, 0.15);
    color: var(--amber);
    font-family: inherit;
    font-size: 13px;
    font-weight: 400;
    line-height: 1.6;
    padding: 12px 18px 12px 42px;
    text-align: left;
    cursor: pointer;
    border-radius: 3px;
    transition: all 0.15s ease;
    position: relative;
    letter-spacing: 0.2px;
  }

  .choice-btn:hover {
    background: var(--amber-faint);
    border-color: var(--amber);
  }

  .choice-btn:active {
    background: rgba(255, 170, 51, 0.1);
  }

  .choice-label {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--amber-dim);
    font-weight: 500;
  }

  .ending-container {
    display: none;
    flex-direction: column;
    min-height: 100%;
  }
  .ending-container.active { display: flex; }

  .ending-text {
    font-size: 14.5px;
    line-height: 1.9;
    font-weight: 300;
    margin-bottom: 28px;
  }

  .ending-badge {
    display: inline-block;
    padding: 5px 14px;
    border-radius: 2px;
    font-size: 11px;
    letter-spacing: 3px;
    text-transform: uppercase;
    font-weight: 500;
    margin-bottom: 28px;
  }

  .ending-badge.win {
    border: 1px solid var(--amber);
    color: var(--amber);
  }

  .ending-badge.loss {
    border: 1px solid var(--red);
    color: var(--red);
  }

  .continue-btn {
    background: transparent;
    border: 1px solid rgba(255, 170, 51, 0.3);
    color: var(--amber);
    font-family: inherit;
    font-size: 11px;
    letter-spacing: 3px;
    text-transform: uppercase;
    padding: 10px 24px;
    cursor: pointer;
    border-radius: 3px;
    transition: all 0.15s ease;
    align-self: flex-start;
  }

  .continue-btn:hover {
    border-color: var(--amber);
    background: var(--amber-faint);
  }

  .results-container {
    display: none;
    flex-direction: column;
    align-items: center;
    min-height: 100%;
    padding-top: 12px;
  }
  .results-container.active { display: flex; }

  .results-logo {
    font-size: 48px;
    line-height: 1;
    margin-bottom: 4px;
  }

  .results-header {
    font-size: 10px;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: var(--amber-dim);
    margin-bottom: 28px;
  }

  .dimension-row {
    width: 100%;
    max-width: 480px;
    margin-bottom: 20px;
  }

  .dimension-labels {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .dim-label { color: var(--amber-dim); transition: all 0.6s ease; }
  .dim-label.active { color: var(--amber); font-weight: 700; }

  .dimension-bar {
    width: 100%;
    height: 12px;
    background: rgba(255, 170, 51, 0.04);
    border-radius: 2px;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 170, 51, 0.08);
  }

  .dimension-bar .center-line {
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 1px;
    background: rgba(255, 170, 51, 0.15);
  }

  .dimension-bar .fill {
    position: absolute;
    top: 2px;
    bottom: 2px;
    border-radius: 1px;
    background: var(--amber);
    transition: width 0.8s ease, left 0.8s ease;
    opacity: 0.85;
  }

  .dimension-value {
    text-align: center;
    font-size: 10px;
    color: var(--amber-dim);
    margin-top: 3px;
    letter-spacing: 1px;
  }

  .results-footer {
    margin-top: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  .play-again-btn {
    background: transparent;
    border: 1px solid rgba(255, 170, 51, 0.3);
    color: var(--amber);
    font-family: inherit;
    font-size: 11px;
    letter-spacing: 3px;
    text-transform: uppercase;
    padding: 10px 24px;
    cursor: pointer;
    border-radius: 3px;
    transition: all 0.15s ease;
  }

  .play-again-btn:hover {
    border-color: var(--amber);
    background: var(--amber-faint);
  }

  .results-tagline {
    font-size: 9px;
    color: var(--amber-dim);
    letter-spacing: 2px;
    opacity: 0.4;
  }

  .scroll-hint {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 5;
    font-size: 9px;
    letter-spacing: 3px;
    color: var(--amber-dim);
    opacity: 0;
    transition: opacity 0.4s ease;
    text-transform: uppercase;
    pointer-events: none;
  }
  .scroll-hint.visible { opacity: 0.5; }
</style>
</head>
<body>

<div class="frame">
  <div class="barrel-wrap">
    <div class="scanlines"></div>
    <div class="barrel-shadow"></div>
    <div class="barrel-warp"></div>

    <div class="screen-inner" id="screenInner">

      <div class="title-screen" id="titleScreen">
        <div class="title-logo">⑃</div>
        <div class="title-name">FORKLE</div>
        <div class="title-story-name" id="titleStoryName"></div>
        <div class="title-objective" id="titleObjective"></div>
        <div class="title-prompt">[ PRESS ANY KEY ]</div>
      </div>

      <div class="game-container" id="gameContainer">
        <div class="hud">
          <div class="hud-left">
            <span class="hud-logo">⑃</span>
            <span class="hud-title" id="hudTitle"></span>
          </div>
          <span class="hud-depth" id="hudDepth"></span>
        </div>
        <div class="scenario-text" id="scenarioText"></div>
        <div class="choices" id="choices"></div>
      </div>

      <div class="ending-container" id="endingContainer">
        <div class="hud">
          <div class="hud-left">
            <span class="hud-logo">⑃</span>
            <span class="hud-title" id="hudTitleEnd"></span>
          </div>
          <span class="hud-depth">END</span>
        </div>
        <div class="ending-text" id="endingText"></div>
        <div class="ending-badge" id="endingBadge"></div>
        <div class="continue-btn" id="continueBtn">VIEW RESULTS →</div>
      </div>

      <div class="results-container" id="resultsContainer">
        <div class="results-logo">⑃</div>
        <div class="results-header">YOUR PERSONALITY</div>
        <div id="dimensionBars"></div>
        <div class="results-footer">
          <div class="play-again-btn" id="playAgainBtn">PLAY AGAIN</div>
          <div class="results-tagline">forkle.org</div>
        </div>
      </div>

    </div>

    <div class="scroll-hint" id="scrollHint">↓ SCROLL ↓</div>
  </div>
</div>

<script>
let story = null;
let currentNodeId = null;
let personalityAccum = { morality: 0, judgement: 0, strategy: 0, risk: 0, social: 0 };
let choiceCount = 0;
let typewriterTimer = null;
const TYPEWRITER_SPEED = 18;

const screenInner      = document.getElementById('screenInner');
const titleScreen      = document.getElementById('titleScreen');
const gameContainer    = document.getElementById('gameContainer');
const endingContainer  = document.getElementById('endingContainer');
const resultsContainer = document.getElementById('resultsContainer');
const scenarioText     = document.getElementById('scenarioText');
const choicesEl        = document.getElementById('choices');
const scrollHint       = document.getElementById('scrollHint');

async function loadStory() {
  const resp = await fetch('story.json');
  story = await resp.json();
  document.getElementById('titleStoryName').textContent = story.title;
  document.getElementById('titleObjective').textContent = `"${story.objective}"`;
}

function startGame() {
  titleScreen.classList.add('hidden');
  gameContainer.classList.add('active');
  document.getElementById('hudTitle').textContent = story.title;
  document.getElementById('hudTitleEnd').textContent = story.title;
  currentNodeId = story.root_id;
  renderNode(currentNodeId);
}

function renderNode(nodeId) {
  const node = story.nodes[nodeId];
  screenInner.scrollTop = 0;
  if (node.is_leaf) { renderEnding(node); return; }

  document.getElementById('hudDepth').textContent = `${node.depth + 1} / ${story.max_depth || '?'}`;
  choicesEl.innerHTML = '';
  choicesEl.classList.remove('visible');
  scenarioText.innerHTML = '';
  typewriterEffect(scenarioText, node.text, () => renderChoices(node.edges));
}

function typewriterEffect(element, text, onComplete) {
  if (typewriterTimer) clearInterval(typewriterTimer);
  let i = 0;
  const cursor = document.createElement('span');
  cursor.className = 'cursor';

  const skipHandler = () => {
    if (i < text.length) {
      clearInterval(typewriterTimer);
      element.textContent = text;
      element.appendChild(cursor);
      i = text.length;
      setTimeout(() => { cursor.remove(); onComplete && onComplete(); }, 200);
    }
  };
  element.addEventListener('click', skipHandler, { once: false });

  typewriterTimer = setInterval(() => {
    if (i < text.length) {
      element.textContent = text.slice(0, i + 1);
      element.appendChild(cursor);
      i++;
    } else {
      clearInterval(typewriterTimer);
      cursor.remove();
      element.removeEventListener('click', skipHandler);
      onComplete && onComplete();
    }
  }, TYPEWRITER_SPEED);
}

function renderChoices(edges) {
  choicesEl.innerHTML = '';
  const labels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
  edges.forEach((edge, i) => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.innerHTML = `<span class="choice-label">${labels[i]}</span>${edge.text}`;
    btn.addEventListener('click', () => selectChoice(edge));
    choicesEl.appendChild(btn);
  });
  requestAnimationFrame(() => choicesEl.classList.add('visible'));
  checkScrollNeeded();
}

function selectChoice(edge) {
  const pv = edge.personality_vector;
  for (const dim in pv) personalityAccum[dim] += pv[dim];
  choiceCount++;
  currentNodeId = edge.target_node_id;
  gameContainer.classList.remove('active');
  setTimeout(() => { gameContainer.classList.add('active'); renderNode(currentNodeId); }, 120);
}

function renderEnding(node) {
  gameContainer.classList.remove('active');
  endingContainer.classList.add('active');
  const endingText = document.getElementById('endingText');
  const badge = document.getElementById('endingBadge');
  endingText.innerHTML = '';
  badge.style.display = 'none';
  typewriterEffect(endingText, node.text, () => {
    badge.textContent = node.is_win ? '◆ ESCAPED ◆' : '◆ CAPTURED ◆';
    badge.className = `ending-badge ${node.is_win ? 'win' : 'loss'}`;
    badge.style.display = 'inline-block';
  });
  document.getElementById('continueBtn').onclick = showResults;
}

function showResults() {
  endingContainer.classList.remove('active');
  resultsContainer.classList.add('active');
  screenInner.scrollTop = 0;

  const barsContainer = document.getElementById('dimensionBars');
  barsContainer.innerHTML = '';
  const dims = story.dimensions;
  const dimKeys = ['morality', 'judgement', 'strategy', 'risk', 'social'];

  dimKeys.forEach((key, i) => {
    const dim = dims[key];
    const raw = choiceCount > 0 ? personalityAccum[key] / choiceCount : 0;
    const val = Math.max(-1, Math.min(1, raw));
    const row = document.createElement('div');
    row.className = 'dimension-row';
    const isPositive = val >= 0;
    const pct = Math.abs(val) * 50;

    row.innerHTML = `
      <div class="dimension-labels">
        <span class="dim-label ${!isPositive ? 'active' : ''}">${dim.negative}</span>
        <span class="dim-label ${isPositive ? 'active' : ''}">${dim.positive}</span>
      </div>
      <div class="dimension-bar">
        <div class="center-line"></div>
        <div class="fill" style="width: 0%; left: 50%"></div>
      </div>
      <div class="dimension-value">${val > 0 ? '+' : ''}${val.toFixed(2)}</div>
    `;
    barsContainer.appendChild(row);

    setTimeout(() => {
      const fill = row.querySelector('.fill');
      if (isPositive) { fill.style.left = '50%'; fill.style.width = `${pct}%`; }
      else { fill.style.left = `${50 - pct}%`; fill.style.width = `${pct}%`; }
    }, 150 + i * 120);
  });

  document.getElementById('playAgainBtn').onclick = resetGame;
}

function resetGame() {
  resultsContainer.classList.remove('active');
  personalityAccum = { morality: 0, judgement: 0, strategy: 0, risk: 0, social: 0 };
  choiceCount = 0;
  currentNodeId = null;
  titleScreen.classList.remove('hidden');
}

function checkScrollNeeded() {
  if (screenInner.scrollHeight > screenInner.clientHeight + 20) scrollHint.classList.add('visible');
  else scrollHint.classList.remove('visible');
}

screenInner.addEventListener('scroll', () => {
  if (screenInner.scrollTop + screenInner.clientHeight >= screenInner.scrollHeight - 20)
    scrollHint.classList.remove('visible');
});

loadStory().then(() => {
  const startHandler = (e) => {
    if (e.type === 'keydown' || e.target.closest('.title-screen')) {
      document.removeEventListener('keydown', startHandler);
      document.removeEventListener('click', startHandler);
      startGame();
    }
  };
  document.addEventListener('keydown', startHandler);
  document.addEventListener('click', startHandler);
});
</script>

</body>
</html>